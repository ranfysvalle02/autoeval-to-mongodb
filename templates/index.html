<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="UTF-8">  
    <title>RAG Task with Metrics Selection</title>  
    <!-- Include Google Fonts -->  
    <link rel="preconnect" href="https://fonts.googleapis.com">  
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">  
  
    <!-- Include Font Awesome for Icons -->  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>  
  
    <!-- Embedded CSS Styles -->  
    <style>  
        /* Global Styles */  
        body {  
            margin: 0;  
            font-family: 'Roboto', sans-serif;  
            background-color: #f5f7fa;  
            color: #333;  
        }  
  
        header, footer {  
            background-color: #2c3e50;  
            color: white;  
            padding: 1em 0;  
            text-align: center;  
            position: sticky;  
            top: 0;  
            z-index: 1000;  
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);  
        }  
  
        header h1 {  
            margin: 0;  
            font-weight: normal;  
        }  
  
        main {  
            padding: 2em;  
            max-width: 1200px;  
            margin: 0 auto;  
        }  
  
        h2 {  
            color: #2c3e50;  
        }  
  
        a {  
            color: #3498db;  
            text-decoration: none;  
        }  
  
        a:hover {  
            text-decoration: underline;  
        }  
  
        /* Button Styles */  
        .btn {  
            display: inline-block;  
            padding: 0.5em 1em;  
            margin: 0.2em 0;  
            background-color: #3498db;  
            color: white;  
            border: none;  
            border-radius: 4px;  
            cursor: pointer;  
            transition: background-color 0.3s ease, transform 0.1s ease;  
            text-decoration: none;  
            text-align: center;  
        }  
  
        .btn:hover {  
            background-color: #2980b9;  
            transform: translateY(-2px);  
        }  
  
        .btn:active {  
            transform: translateY(0);  
        }  
  
        .btn.danger {  
            background-color: #e74c3c;  
        }  
  
        .btn.danger:hover {  
            background-color: #c0392b;  
        }  
  
        .btn.primary {  
            background-color: #1abc9c;  
        }  
  
        .btn.primary:hover {  
            background-color: #16a085;  
        }  
  
        .btn.icon {  
            padding: 0.5em;  
            width: 2.5em;  
            height: 2.5em;  
            text-align: center;  
        }  
  
        .btn.icon i {  
            margin: 0;  
        }  
  
        .form-group {  
            margin-bottom: 1.5em;  
        }  
  
        .form-group label {  
            display: block;  
            font-weight: bold;  
            margin-bottom: 0.5em;  
        }  
  
        .form-group input[type="text"],  
        .form-group textarea,  
        .form-group select {  
            width: 100%;  
            padding: 0.75em;  
            border: 1px solid #ccd1d9;  
            border-radius: 4px;  
            transition: border-color 0.3s ease, box-shadow 0.3s ease;  
            font-size: 1em;  
        }  
  
        .form-group input[type="text"]:focus,  
        .form-group textarea:focus,  
        .form-group select:focus {  
            border-color: #3498db;  
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.1);  
            outline: none;  
        }  
  
        .form-actions {  
            margin-top: 1em;  
        }  
  
        .table-responsive {  
            overflow-x: auto;  
            margin-bottom: 1.5em;  
        }  
  
        table {  
            width: 100%;  
            border-collapse: collapse;  
            background-color: white;  
            margin-bottom: 1em;  
        }  
  
        table thead {  
            background-color: #34495e;  
            color: white;  
            text-align: left;  
        }  
  
        table th, table td {  
            padding: 1em;  
            border-bottom: 1px solid #ddd;  
            vertical-align: middle;  
        }  
  
        table tbody tr {  
            transition: background-color 0.3s ease;  
        }  
  
        table tbody tr:hover {  
            background-color: #f9f9f9;  
        }  
  
        table input[type="text"] {  
            width: 100%;  
            padding: 0.5em;  
            border: 1px solid #ccd1d9;  
            border-radius: 4px;  
            font-size: 0.95em;  
        }  
  
        /* Modal Styles */  
        .modal {  
            display: none; /* Hidden by default */  
            position: fixed; /* Stay in place */  
            z-index: 10000; /* Sit on top */  
            left: 0;  
            top: 0;  
            width: 100%; /* Full width */  
            height: 100%; /* Full height */  
            overflow: auto; /* Enable scroll if needed */  
            background-color: rgba(0,0,0,0.5); /* Black w/ opacity */  
        }  
  
        .modal-content {  
            background-color: #fefefe;  
            margin: 5% auto; /* Centered vertically and horizontally */  
            padding: 2em;  
            border: 1px solid #888;  
            width: 80%;  
            max-width: 800px;  
            border-radius: 5px;  
            position: relative;  
            overflow-y: auto;  
            max-height: 80vh;  
        }  
  
        .modal-content .close {  
            color: #aaa;  
            position: absolute;  
            right: 1em;  
            top: 1em;  
            font-size: 28px;  
            font-weight: bold;  
            text-decoration: none;  
        }  
  
        .modal-content .close:hover,  
        .modal-content .close:focus {  
            color: black;  
            text-decoration: none;  
            cursor: pointer;  
        }  
  
        /* Loading Spinner Styles */  
        .spinner {  
            margin: 50px auto;  
            width: 50px;  
            height: 50px;  
            position: relative;  
            text-align: center;  
            animation: rotate 2.0s infinite linear;  
        }  
  
        .spinner > div {  
            width: 18px;  
            height: 18px;  
            background-color: #3498db;  
  
            border-radius: 100%;  
            display: inline-block;  
            position: absolute;  
            animation: bounce 2.0s infinite ease-in-out;  
        }  
  
        .spinner .bounce1 {  
            top: 0;  
            animation-delay: -0.32s;  
        }  
  
        .spinner .bounce2 {  
            top: auto;  
            bottom: 0;  
            animation-delay: -0.16s;  
        }  
  
        @keyframes rotate { 100% { transform: rotate(360deg); } }  
        @keyframes bounce {  
            0%, 80%, 100% { transform: scale(0); }  
            40% { transform: scale(1.0); }  
        }  
  
        .error {  
            color: #e74c3c;  
            font-size: 0.9em;  
        }  
  
        /* Responsive Design */  
        @media (max-width: 768px) {  
            main {  
                padding: 1em;  
            }  
            .modal-content {  
                width: 90%;  
            }  
            .form-group input[type="text"],  
            .form-group textarea,  
            .form-group select {  
                font-size: 0.9em;  
            }  
            table th, table td {  
                padding: 0.5em;  
            }  
            .modal-content {  
                width: 95%;  
            }  
        }  
  
        /* Hide the loading indicator by default */  
        #loading {  
            display: none;  
            text-align: center;  
        }  
  
        /* Collapsible Button Styles */  
        .collapsible {  
            background-color: #f1f1f1;  
            color: #2c3e50;  
            cursor: pointer;  
            padding: 0.5em 1em;  
            width: 100%;  
            border: none;  
            text-align: left;  
            outline: none;  
            font-size: 1em;  
            transition: background-color 0.3s ease;  
            border-radius: 5px;  
        }  
  
        .collapsible:hover {  
            background-color: #e2e2e2;  
        }  
  
        .collapsible:after {  
            content: '\002B';  
            font-size: 1em;  
            color: #777;  
            float: right;  
            margin-left: 5px;  
        }  
  
        .collapsible.active:after {  
            content: "\2212";  
        }  
  
        .content {  
            padding: 0 1em;  
            max-height: 0;  
            overflow: hidden;  
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;  
            background-color: #fafafa;  
            border-left: 1px solid #ddd;  
            border-right: 1px solid #ddd;  
            border-bottom: 1px solid #ddd;  
        }  
    </style>  
  
    <!-- Embedded JavaScript -->  
    <script>  
        function showLoading() {  
            document.getElementById('loading').style.display = 'block';  
        }  
  
        function submitPreview(idx) {  
            // Open the modal and show loading indicator  
            openPreviewModal();  
  
            // Gather the form data  
            var formData = new FormData();  
            var testCaseCountInput = document.getElementsByName('test_case_count')[0];  
            var testCaseCount = testCaseCountInput.value;  
  
            formData.append('test_case_count', testCaseCount);  
  
            // Append deployment_name  
            var deploymentNameField = document.getElementsByName('deployment_name')[0];  
            formData.append('deployment_name', deploymentNameField.value);  
  
            // Append response_criteria  
            var responseCriteriaField = document.getElementsByName('response_criteria')[0];  
            formData.append('response_criteria', responseCriteriaField.value);  
  
            // Append system_prompt_template  
            var systemPromptField = document.getElementsByName('system_prompt_template')[0];  
            formData.append('system_prompt_template', systemPromptField.value);  
  
            // Append user_prompt_template  
            var userPromptField = document.getElementsByName('user_prompt_template')[0];  
            formData.append('user_prompt_template', userPromptField.value);  
  
            // Append selected metrics  
            var metricCheckboxes = document.getElementsByName('metrics');  
            for (var i = 0; i < metricCheckboxes.length; i++) {  
                if (metricCheckboxes[i].checked) {  
                    formData.append('metrics', metricCheckboxes[i].value);  
                }  
            }  
  
            // Append the specific test case input and expected output  
            var inputPromptField = document.getElementsByName('input_prompt_' + idx)[0];  
            var expectedOutputField = document.getElementsByName('expected_output_' + idx)[0];  
            formData.append('input_prompt_' + idx, inputPromptField.value);  
            formData.append('expected_output_' + idx, expectedOutputField.value);  
  
            // Add test_case_idx  
            formData.append('test_case_idx', idx);  
  
            // Make an AJAX request to /preview  
            var xhr = new XMLHttpRequest();  
            xhr.open('POST', '/preview', true);  
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');  
  
            xhr.onload = function() {  
                if (xhr.status === 200) {  
                    // Display the preview content in the modal  
                    document.getElementById('previewContent').innerHTML = xhr.responseText;  
                    // Initialize the collapsible elements  
                    initializeCollapsibles();  
                } else {  
                    document.getElementById('previewContent').innerHTML = '<p class="error">An error occurred while fetching the preview.</p>';  
                }  
            };  
  
            xhr.onerror = function() {  
                document.getElementById('previewContent').innerHTML = '<p class="error">An error occurred while fetching the preview.</p>';  
            };  
  
            xhr.send(formData);  
        }  
  
        function openPreviewModal() {  
            document.getElementById('previewModal').style.display = 'block';  
            // Show loading indicator  
            document.getElementById('previewContent').innerHTML = '<div class="spinner"><div class="bounce1"></div><div class="bounce2"></div></div><p style="text-align:center;">Loading preview...</p>';  
        }  
  
        function closePreviewModal() {  
            document.getElementById('previewModal').style.display = 'none';  
            document.getElementById('previewContent').innerHTML = '';  
        }  
  
        function removeTestCase(testCaseId) {  
            var confirmation = confirm("Are you sure you want to remove this test case?");  
            if (confirmation) {  
                var form = document.getElementById('remove_test_case_form');  
                var input = document.getElementById('test_case_id_to_remove');  
                input.value = testCaseId;  
                form.submit();  
            }  
        }  
  
        function openAddTestCaseModal() {  
            document.getElementById('addTestCaseModal').style.display = 'block';  
        }  
  
        function closeAddTestCaseModal() {  
            document.getElementById('addTestCaseModal').style.display = 'none';  
            clearAddTestCaseForm();  
        }  
  
        function clearAddTestCaseForm() {  
            document.getElementById('new_input_prompt').value = '';  
            document.getElementById('new_expected_output').value = '';  
            document.getElementById('addTestCaseError').innerText = '';  
        }  
  
        function validateAddTestCaseForm() {  
            var inputPrompt = document.getElementById('new_input_prompt').value.trim();  
            var expectedOutput = document.getElementById('new_expected_output').value.trim();  
            var errorElement = document.getElementById('addTestCaseError');  
  
            if (inputPrompt === '' || expectedOutput === '') {  
                errorElement.innerText = 'Both fields are required.';  
                return false;  
            }  
  
            return true;  
        }  
  
        // Function to initialize collapsible elements  
        function initializeCollapsibles() {  
            var coll = document.getElementById('previewContent').getElementsByClassName("collapsible");  
            for (var i = 0; i < coll.length; i++) {  
                coll[i].addEventListener("click", function() {  
                    this.classList.toggle("active");  
                    // Assuming the button is inside an h4, and the content div is the next sibling after h4  
                    var content = this.parentElement.nextElementSibling;  
                    if (content && content.classList.contains('content')) {  
                        if (content.style.maxHeight){  
                            content.style.maxHeight = null;  
                            content.style.padding = null;  
                        } else {  
                            content.style.maxHeight = content.scrollHeight + "px";  
                            content.style.padding = "1em 0";  
                        }  
                    }  
                });  
            }  
        }  
  
        // Close modal when clicking outside of it  
        window.onclick = function(event) {  
            var modal = document.getElementById('addTestCaseModal');  
            var previewModal = document.getElementById('previewModal');  
            if (event.target == modal) {  
                closeAddTestCaseModal();  
            }  
            if (event.target == previewModal) {  
                closePreviewModal();  
            }  
        };  
    </script>  
</head>  
<body>  
    <header>  
        <h1>RAG Task with Metrics Selection</h1>  
    </header>  
  
    <main>  
        <!-- Modal for adding a new test case -->  
        <div id="addTestCaseModal" class="modal">  
            <div class="modal-content">  
                <a href="javascript:void(0);" class="close" onclick="closeAddTestCaseModal()">&times;</a>  
                <h2>Add New Test Case</h2>  
                <form id="add_test_case_form" method="post" action="/add_test_case" onsubmit="return validateAddTestCaseForm();">  
                    <div class="form-group">  
                        <label for="new_input_prompt">Input Prompt:</label>  
                        <input type="text" id="new_input_prompt" name="new_input_prompt" required>  
                    </div>  
                    <div class="form-group">  
                        <label for="new_expected_output">Expected Output:</label>  
                        <input type="text" id="new_expected_output" name="new_expected_output" required>  
                    </div>  
                    <div class="error" id="addTestCaseError"></div>  
                    <div class="form-actions">  
                        <button type="submit" class="btn primary">Add Test Case</button>  
                        <button type="button" class="btn" onclick="closeAddTestCaseModal()">Cancel</button>  
                    </div>  
                </form>  
            </div>  
        </div>  
  
        <!-- Modal for previewing a test case -->  
        <div id="previewModal" class="modal">  
            <div class="modal-content">  
                <a href="javascript:void(0);" class="close" onclick="closePreviewModal()">&times;</a>  
                <h2>Preview Result</h2>  
                <div id="previewContent">  
                    <!-- Preview content or loading indicator will be injected here -->  
                </div>  
                <div class="form-actions">  
                    <button type="button" class="btn" onclick="closePreviewModal()"><i class="fa fa-times"></i> Close</button>  
                </div>  
            </div>  
        </div>  
  
        <!-- Form for removing a test case -->  
        <form id="remove_test_case_form" method="post" action="/remove_test_case" style="display: none;">  
            <input type="hidden" name="test_case_id_to_remove" id="test_case_id_to_remove">  
        </form>  
  
        <section class="test-dataset">  
            <h2>Test Dataset Evaluation</h2>  
            <form id="test_dataset_form" method="post">  
                <!-- Deployment Selection -->  
                <div class="form-group">  
                    <label for="deployment_name">Select Deployment Name:</label>  
                    <select name="deployment_name">  
                        {% for name in deployment_names %}  
                        <option value="{{ name }}" {% if name == default_deployment %}selected{% endif %}>{{ name }}</option>  
                        {% endfor %}  
                    </select>  
                </div>  
  
                <!-- System Prompt Template Input -->  
                <div class="form-group">  
                    <label for="system_prompt_template">System Prompt Template:</label>  
                    <textarea name="system_prompt_template" rows="6">{{ default_system_prompt }}</textarea>  
                </div>  
  
                <!-- User Prompt Template Input -->  
                <div class="form-group">  
                    <label for="user_prompt_template">User Prompt Template:</label>  
                    <textarea name="user_prompt_template" rows="6">{{ default_user_prompt }}</textarea>  
                </div>  
  
                <!-- Response Criteria Input -->  
                <div class="form-group">  
                    <label for="response_criteria">Response Criteria:</label>  
                    <textarea name="response_criteria" rows="4">{{ default_response_criteria }}</textarea>  
                </div>  
  
                <!-- Metric Selection -->  
                <div class="form-group">  
                    <label>Select Evaluation Metrics:</label>  
                    <div>  
                        {% for metric in available_metrics %}  
                        <label>  
                            <input type="checkbox" name="metrics" value="{{ metric.name }}" {% if metric.selected %}checked{% endif %}>  
                            {{ metric.name }}  
                        </label><br>  
                        {% endfor %}  
                    </div>  
                </div>  
  
                <!-- Test Cases Table -->  
                <div class="table-responsive">  
                    <table id="test_cases_table">  
                        <thead>  
                            <tr>  
                                <th>ID</th>  
                                <th>Input Prompt</th>  
                                <th>Expected Output</th>  
                                <th>Actions</th>  
                            </tr>  
                        </thead>  
                        <tbody>  
                            {% for case in test_dataset %}  
                            <tr>  
                                <td>{{ case.id }}</td>  
                                <td>  
                                    <input type="text" name="input_prompt_{{ loop.index0 }}" value="{{ case.input }}">  
                                </td>  
                                <td>  
                                    <input type="text" name="expected_output_{{ loop.index0 }}" value="{{ case.expected }}">  
                                </td>  
                                <td>  
                                    <button type="button" class="btn icon" onclick="submitPreview({{ loop.index0 }})" title="Preview"><i class="fa fa-eye"></i></button>  
                                    <button type="button" class="btn icon danger" onclick="removeTestCase({{ case.id }})" title="Remove"><i class="fa fa-trash"></i></button>  
                                </td>  
                            </tr>  
                            {% endfor %}  
                        </tbody>  
                    </table>  
                </div>  
  
                <input type="hidden" name="test_case_count" value="{{ test_dataset|length }}">  
                <div class="form-actions">  
                    <button type="submit" class="btn primary" formaction="/run_test" onclick="showLoading()"><i class="fa fa-play"></i> Run Test on Test Dataset</button>  
                </div>  
            </form>  
        </section>  
        <!-- Button to open the modal -->  
        <div class="form-actions">  
            <button type="button" class="btn primary" onclick="openAddTestCaseModal()"><i class="fa fa-plus"></i> Add New Test Case</button>  
            <form method="get" action="/reset" style="display: inline;">  
                <button type="submit" class="btn"><i class="fa fa-undo"></i> Reset Test Dataset to Default</button>  
            </form>  
        </div>  
  
        <section class="previous-runs">  
            <h2>Previous Test Runs</h2>  
            <div class="table-responsive">  
                <table>  
                    <thead>  
                        <tr>  
                            <th>Timestamp</th>  
                            <th>Deployment Name</th>  
                            <th>Average Scores</th>  
                            <th>Duration (s)</th> <!-- Added this column -->  
                            <th>Test Cases</th>  
                            <th>Actions</th>  
                        </tr>  
                    </thead>  
                    <tbody>  
                        {% for run in previous_runs %}  
                        <tr>  
                            <td>{{ run.timestamp }}</td>  
                            <td>{{ run.deployment_name }}</td>  
                            <td>  
                                {% for metric_name, avg_score in run.average_scores.items() %}  
                                    {{ metric_name }}: {{ "%.2f"|format(avg_score) }}<br>  
                                {% endfor %}  
                            </td>  
                            <td>  
                                {% if run.total_duration_seconds %}  
                                    {{ "%.2f"|format(run.total_duration_seconds) }}  
                                {% else %}  
                                    N/A  
                                {% endif %}  
                            </td> <!-- Added duration display -->  
                            <td>  
                                {% for case in run.test_cases %}  
                                    {{ loop.index }}. {{ case.input_prompt | truncate(50) }}<br>  
                                {% endfor %}  
                            </td>  
                            <td>  
                                <a href="/test_run/{{ run._id }}" class="btn icon" title="View Results"><i class="fa fa-file-alt"></i></a>  
                            </td>  
                        </tr>  
                        {% endfor %}  
                    </tbody>  
                </table>  
            </div>  
            <a href="/test_runs" class="btn"><i class="fa fa-list"></i> View All Test Runs</a>  
        </section>  
  
        <!-- Loading Indicator for Running Test -->  
        <div id="loading">  
            <div class="spinner"><div class="bounce1"></div><div class="bounce2"></div></div>  
            <p>Processing...</p>  
        </div>  
    </main>  
  
    <footer>  
        <p>&copy; {{ current_year }} Your Company Name</p>  
    </footer>  
</body>  
</html>  