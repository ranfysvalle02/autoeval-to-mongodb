<!-- list_indexes.html -->  
<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="UTF-8">  
    <title>Manage Atlas Search Indexes</title>  
     <!-- Include Google Fonts -->          
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">          
    <link href="https://fonts.googleapis.com/css2?family=Bitcount+Grid+Double:wght@100..900&display=swap" rel="stylesheet">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>          
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}"/>
    
</head>  
<body>  
    <header>  
        <div class="logo-container">  
            <img src="https://mongodb.gallerycdn.vsassets.io/extensions/mongodb/mongodb-vscode/1.13.3/1749482419080/Microsoft.VisualStudio.Services.Icons.Default" alt="MongoDB Logo">  
            <img src="https://res.cloudinary.com/ilaeweb/image/upload/c_fill,w_600,g_auto,q_auto,dpr_3.0,f_auto/ilae-climate-change-commission-brainleafsolus-colour2_D6D4D903-A7B7-9F1F-3758BEC807504AD1.png" alt="Additional Logo">  
            <h1>MDBEvalHub: Atlas Search Indexes</h1>  
        </div>  
    </header>   
  
    <nav>    
        <ul >
            <li><a href="/" class="btn" style="height: 30px; border-radius: 0;"><i class="fa fa-home"></i> Back to Home</a>  </li>
            <li>&nbsp;</li>
        </ul> 
    </nav> 
  
    <main>  
        <section>
        {% if error_message %}  
            <p class="error">{{ error_message }}</p>  
        {% endif %}  
        {% if success_message %}  
            <p class="success">{{ success_message }}</p>  
        {% endif %}  
  
        <h2>Create New Index</h2>  
        <form method="post" action="{{ url_for('list_indexes') }}">  
            <input type="hidden" name="action" value="create_index">  
            <div class="form-group">  
                <label for="db_name">Source Database:</label>  
                <select id="db_name" name="db_name" required>  
                    <option value="">-- Select Database --</option>  
                    {% for db in source_databases %}  
                        <option value="{{ db.name }}">{{ db.name }}</option>  
                    {% endfor %}  
                </select>  
            </div>  
            <div class="form-group">  
                <label for="collection_name">Source Collection:</label>  
                <select id="collection_name" name="collection_name" required>  
                    <option value="">-- Select Collection --</option>  
                    <!-- Options will be populated via JavaScript -->  
                </select>  
            </div>  
            <div class="form-group">  
                <label for="source_field">Source Field:</label>  
                <select id="source_field" name="source_field" required>  
                    <option value="">-- Select Source Field --</option>  
                    <!-- Options will be populated via JavaScript -->  
                </select>  
            </div>  
            <div class="form-group">  
                <label for="embedding_field">Embedding Field Prefix:</label>  
                <input type="text" id="embedding_field" name="embedding_field" required placeholder="Enter field prefix for embeddings">  
                <small>Embedding fields will be named as [prefix][ModelName]</small>  
            </div>  
            <div class="form-group">  
                <label for="match_stage">Match Stage (JSON format):</label>  
                <textarea id="match_stage" name="match_stage" placeholder='Enter JSON for $match stage (e.g., {"field": "value"})'></textarea>  
                <small>Optional: Provide a $match stage to filter documents when cloning.</small>  
            </div>  
            <div class="form-group">  
                <label>Embedding Models:</label>  
                {% for model_name, model_info in embedding_models.items() %}  
                    <div>  
                        <input type="checkbox" id="model_{{ model_name }}" name="embedding_models" value="{{ model_name }}">  
                        <label for="model_{{ model_name }}">{{ model_name }}</label>  
                    </div>  
                {% endfor %}  
            </div>  
            <div class="form-group">  
                <label for="records_limit">Number of Records to Process (Default 100):</label>  
                <input type="number" id="records_limit" name="records_limit" value="100" min="1">  
            </div>  
            <!-- We default to cosine similarity and do not expose it to the user -->  
            <div class="form-actions">  
                <button type="submit" class="btn">Create Index</button>  
            </div>  
        </form>          
        </section>
    </main>  
  
    <footer>  

    </footer>  
  
    <!-- JavaScript for Accordion and Dynamic Collection Loading -->  
    <script>  
        function toggleAccordion(element) {  
            element.classList.toggle("active");  
            var content = element.nextElementSibling;  
            if (content.style.display === "block") {  
                content.style.display = "none";  
            } else {  
                content.style.display = "block";  
            }  
        }  
  
        // Create a mapping of databases to their collections  
        var dbCollections = {};  
        {% for db in source_databases %}  
            dbCollections["{{ db.name }}"] = [  
                {% for collection in db.collections %}  
                    "{{ collection.name }}"{% if not loop.last %},{% endif %}  
                {% endfor %}  
            ];  
        {% endfor %}  
  
        // Create a mapping of collection to their fields  
        var collectionFields = {};  
        {% for db in source_databases %}  
            {% for collection in db.collections %}  
                collectionFields["{{ db.name }}.{{ collection.name }}"] = [  
                    {% for field in collection.fields %}  
                        "{{ field }}"{% if not loop.last %},{% endif %}  
                    {% endfor %}  
                ];  
            {% endfor %}  
        {% endfor %}  
  
        // JavaScript to populate collections based on selected database  
        document.getElementById('db_name').addEventListener('change', function() {  
            var dbName = this.value;  
            var collectionSelect = document.getElementById('collection_name');  
            var sourceFieldSelect = document.getElementById('source_field');  
            collectionSelect.innerHTML = '<option value="">-- Select Collection --</option>';  
            sourceFieldSelect.innerHTML = '<option value="">-- Select Source Field --</option>';  
            if (dbName !== '') {  
                var collections = dbCollections[dbName] || [];  
                collections.forEach(function(collectionName) {  
                    var option = document.createElement('option');  
                    option.value = collectionName;  
                    option.text = collectionName;  
                    collectionSelect.add(option);  
                });  
            }  
        });  
  
        // Populate fields based on selected collection  
        document.getElementById('collection_name').addEventListener('change', function() {  
            var dbName = document.getElementById('db_name').value;  
            var collectionName = this.value;  
            var sourceFieldSelect = document.getElementById('source_field');  
            sourceFieldSelect.innerHTML = '<option value="">-- Select Source Field --</option>';  
            if (dbName !== '' && collectionName !== '') {  
                var key = dbName + '.' + collectionName;  
                var fields = collectionFields[key] || [];  
                fields.forEach(function(fieldName) {  
                    var option = document.createElement('option');  
                    option.value = fieldName;  
                    option.text = fieldName;  
                    sourceFieldSelect.add(option);  
                });  
            }  
        });  
    </script>  
</body>  
</html>  