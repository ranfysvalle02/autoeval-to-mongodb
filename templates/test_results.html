<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="UTF-8">  
    <title>Test Results</title>  
    <!-- Include Google Fonts and Font Awesome -->  
    <link rel="preconnect" href="https://fonts.googleapis.com">  
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">  
    <!-- Include Font Awesome for Icons -->  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>  
  
    <!-- Embedded CSS Styles -->  
    <style>  
        /* Global Styles */  
        body {  
            margin: 0;  
            font-family: 'Roboto', sans-serif;  
            background-color: #ffffff;  
            color: #212529;  
        }  
  
        header, footer {  
            background-color: #343a40;  
            color: #f8f9fa;  
            padding: 1em 0;  
            text-align: center;  
            position: sticky;  
            top: 0;  
            z-index: 1000;  
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);  
        }  
  
        header h1 {  
            margin: 0;  
            font-weight: normal;  
        }  
  
        main {  
            padding: 2em;  
            max-width: 1200px;  
            margin: 0 auto;  
        }  
  
        h2 {  
            color: #343a40;  
            margin-top: 1.5em;  
        }  
  
        a {  
            color: #007bff;  
            text-decoration: none;  
        }  
  
        a:hover {  
            text-decoration: underline;  
        }  
  
        /* Button Styles */  
        .btn {  
            display: inline-block;  
            padding: 0.5em 1em;  
            margin: 0.2em 0;  
            background-color: #007bff;  
            color: #fff;  
            border: none;  
            border-radius: 4px;  
            cursor: pointer;  
            transition: background-color 0.3s ease, transform 0.1s ease;  
            text-decoration: none;  
            text-align: center;  
        }  
  
        .btn:hover {  
            background-color: #0056b3;  
            transform: translateY(-2px);  
        }  
  
        .btn:active {  
            transform: translateY(0);  
        }  
  
        .btn.icon {  
            padding: 0.5em;  
            width: 2.5em;  
            height: 2.5em;  
            text-align: center;  
        }  
  
        .btn.icon i {  
            margin: 0;  
        }  
  
        .form-group {  
            margin-bottom: 1.5em;  
        }  
  
        .form-group label {  
            display: block;  
            font-weight: bold;  
            margin-bottom: 0.5em;  
        }  
  
        pre {  
            background-color: #f8f9fa;  
            padding: 1em;  
            border-radius: 5px;  
            overflow-x: auto;  
        }  
  
        table {  
            width: 100%;  
            border-collapse: collapse;  
            margin-bottom: 1.5em;  
        }  
  
        table th, table td {  
            padding: 1em;  
            border-bottom: 1px solid #dee2e6;  
            text-align: left;  
            vertical-align: top;  
        }  
  
        table thead {  
            background-color: #343a40;  
            color: #f8f9fa;  
        }  
  
        /* Modal Styles */  
        .modal {  
            display: none; /* Hidden by default */  
            position: fixed; /* Stay in place */  
            z-index: 10000; /* Sit on top */  
            left: 0;  
            top: 0;  
            width: 100%; /* Full width */  
            height: 100%; /* Full height */  
            overflow: auto; /* Enable scroll if needed */  
            background-color: rgba(0,0,0,0.5); /* Black w/ opacity */  
        }  
  
        .modal-content {  
            background-color: #ffffff;  
            margin: 5% auto;  
            padding: 2em;  
            border: 1px solid #888;  
            width: 80%;  
            max-width: 800px;  
            border-radius: 5px;  
            position: relative;  
            overflow-y: auto; /* Enable vertical scrolling if content is long */  
            max-height: 80vh; /* Limit the modal height to 80% of viewport */  
        }  
  
        .modal-content .close {  
            color: #aaa;  
            position: absolute;  
            right: 1em;  
            top: 1em;  
            font-size: 28px;  
            font-weight: bold;  
            text-decoration: none;  
        }  
  
        .modal-content .close:hover,  
        .modal-content .close:focus {  
            color: black;  
            text-decoration: none;  
            cursor: pointer;  
        }  
  
        /* Styles for chat messages */  
        .chat-message {  
            display: flex;  
            margin-bottom: 1em;  
        }  
  
        .chat-message .avatar {  
            width: 50px;  
            margin-right: 1em;  
            text-align: center;  
        }  
  
        .chat-message .avatar i {  
            font-size: 2em;  
            color: #7f8c8d;  
        }  
  
        .chat-message .message-content {  
            padding: 1em;  
            border-radius: 10px;  
            max-width: 80%;  
            word-wrap: break-word;  
        }  
  
        .chat-message.system .message-content {  
            background-color: #f1f1f1;  
            color: #212529;  
        }  
  
        .chat-message.user .message-content {  
            background-color: #007bff;  
            color: #fff;  
        }  
  
        .chat-message.assistant .message-content {  
            background-color: #28a745;  
            color: #ffffff;  
        }  
  
        .chat-message .message-content pre {  
            margin: 0;  
            white-space: pre-wrap; /* Wrap long lines */  
            word-wrap: break-word;  
            color: black;
            font-weight: bold;
        }  
  
        /* Responsive Design */  
        @media (max-width: 768px) {  
            main {  
                padding: 1em;  
            }  
            table th, table td {  
                padding: 0.5em;  
            }  
            .modal-content {  
                width: 95%;  
            }  
            .chat-message .message-content {  
                max-width: 100%;  
            }  
        }  
    </style>  
  
    <!-- Embedded JavaScript -->  
    <script>  
        function openMessagesModal(testCaseId, deploymentName) {  
            // Get the modal element  
            var modal = document.getElementById('messagesModal');  
            // Get the content element where messages will be displayed  
            var contentElement = document.getElementById('modalContent');  
            // Get the messages data from the hidden input  
            var messagesDataId = 'messagesData_' + testCaseId + '_' + deploymentName;  
            var messagesData = document.getElementById(messagesDataId).value;  
            // Parse the messages JSON  
            var messages = JSON.parse(messagesData);  
  
            // Clear previous content  
            contentElement.innerHTML = '';  
  
            // Loop through messages and create chat bubbles  
            messages.forEach(function(message) {  
                var messageElement = document.createElement('div');  
                messageElement.classList.add('chat-message', message.role);  
  
                var avatarElement = document.createElement('div');  
                avatarElement.classList.add('avatar');  
                var avatarIcon = document.createElement('i');  
  
                // Set avatar icon based on role  
                if (message.role === 'system') {  
                    avatarIcon.classList.add('fas', 'fa-cog');  
                } else if (message.role === 'user') {  
                    avatarIcon.classList.add('fas', 'fa-user');  
                } else if (message.role === 'assistant') {  
                    avatarIcon.classList.add('fas', 'fa-robot');  
                } else {  
                    avatarIcon.classList.add('fas', 'fa-comment');  
                }  
                avatarElement.appendChild(avatarIcon);  
  
                var contentDiv = document.createElement('div');  
                contentDiv.classList.add('message-content');  
                var contentPre = document.createElement('pre');  
                contentPre.textContent = message.content;  
                contentDiv.appendChild(contentPre);  
  
                messageElement.appendChild(avatarElement);  
                messageElement.appendChild(contentDiv);  
  
                contentElement.appendChild(messageElement);  
            });  
  
            // Display the modal  
            modal.style.display = 'block';  
        }  
  
        function closeMessagesModal() {  
            var modal = document.getElementById('messagesModal');  
            modal.style.display = 'none';  
            var contentElement = document.getElementById('modalContent');  
            contentElement.innerHTML = '';  
        }  
  
        window.onclick = function(event) {  
            var modal = document.getElementById('messagesModal');  
            if (event.target == modal) {  
                closeMessagesModal();  
            }  
        };  
    </script>  
</head>  
<body>  
    <header>  
        <h1>Test Run Results</h1>  
    </header>  
  
    <main>  
        <section>  
            <h2>Summary</h2>  
            <p><strong>Timestamp:</strong> {{ test_run.timestamp }}</p>  
            <p><strong>Deployment Names:</strong> {{ test_run.deployment_names | join(", ") }}</p>  
            <p><strong>Number of Test Cases:</strong> {{ test_run.test_cases | length }}</p>  
            <p><strong>Total Duration (s):</strong>  
                {% if test_run.total_duration_seconds %}  
                    {{ "%.2f"|format(test_run.total_duration_seconds) }}  
                {% else %}  
                    N/A  
                {% endif %}  
            </p> <!-- Added duration display -->  
  
            <div class="prompt-templates">  
                <h2>System Prompt Template Used:</h2>  
                <pre>{{ test_run.system_prompt_template }}</pre>  
  
                <h2>User Prompt Template Used:</h2>  
                <pre>{{ test_run.user_prompt_template }}</pre>  
  
                <h2>Response Criteria Used:</h2>  
                <pre>{{ test_run.response_criteria }}</pre>  
            </div>  
  
            <h2>Test Cases</h2>  
            {% for deployment_name in test_run.deployment_names %}  
                <h3>Results for Model: {{ deployment_name }}</h3>  
                <div class="table-responsive">  
                    <table>  
                        <thead>  
                            <tr>  
                                <th>ID</th>  
                                <th>Input Prompt</th>  
                                <th>Expected Output</th>  
                                <th>Generated Output</th>  
                                {% for metric_name in test_run.selected_metrics %}  
                                <th>{{ metric_name }} Score</th>  
                                {% endfor %}  
                                <th>Messages</th>  
                            </tr>  
                        </thead>  
                        <tbody>  
                            {% for case in test_run.models[deployment_name].test_cases %}  
                            <tr>  
                                <td>{{ case.test_case_id }}</td>  
                                <td>{{ case.input_prompt }}</td>  
                                <td>{{ case.expected_output }}</td>  
                                <td>{{ case.generated_output }}</td>  
                                {% for metric_name in test_run.selected_metrics %}  
                                <td>{{ "%.2f"|format(case.metric_results[metric_name]['score']) }}</td>  
                                {% endfor %}  
                                <td>  
                                    <input type="hidden" id="messagesData_{{ case.test_case_id }}_{{ deployment_name }}" value='{{ case.messages | tojson }}'>  
                                    <button type="button" class="btn" onclick="openMessagesModal('{{ case.test_case_id }}', '{{ deployment_name }}')"><i class="fa fa-comments"></i> View Messages</button>  
                                </td>  
                            </tr>  
                            {% endfor %}  
                        </tbody>  
                    </table>  
                </div>  
                <h4>Average Scores for {{ deployment_name }}</h4>  
                <ul>  
                    {% for metric_name, avg_score in test_run.models[deployment_name].average_scores.items() %}  
                    <li><strong>{{ metric_name }}:</strong> {{ "%.2f"|format(avg_score) }}</li>  
                    {% endfor %}  
                </ul>  
            {% endfor %}  
  
            <div class="form-actions">  
                <a href="/" class="btn"><i class="fa fa-home"></i> Back to Home</a>  
                <a href="/test_runs" class="btn"><i class="fa fa-list"></i> View All Test Runs</a>  
            </div>  
        </section>  
    </main>  
  
    <!-- Messages Modal -->  
    <div id="messagesModal" class="modal">  
        <div class="modal-content">  
            <a href="javascript:void(0);" class="close" onclick="closeMessagesModal()">&times;</a>  
            <h2>Messages Sent to Azure Client</h2>  
            <div id="modalContent">  
                <!-- Chat messages will be injected here -->  
            </div>  
            <div class="form-actions">  
                <button type="button" class="btn" onclick="closeMessagesModal()"><i class="fa fa-times"></i> Close</button>  
            </div>  
        </div>  
    </div>  
  
    <footer>  
        <p>&copy; {{ current_year }} Your Company Name</p>  
    </footer>  
</body>  
</html>  